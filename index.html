<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chúc các em thi tốt nha!!!</title>
    <style>
        /* CSS CŨ CỦA BẠN (GIỮ NGUYÊN HOÀN TOÀN) */
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2;
            color: white;
            text-align: center;
            transition: opacity 1s ease-out, visibility 1s ease-out;
        }
        #start-screen.hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
        #start-screen h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
        }
        #start-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 80%;
        }
        #name-input {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            border: 2px solid white;
            background-color: transparent;
            color: white;
            text-align: center;
            width: 300px;
            margin-bottom: 30px;
            outline: none;
        }
        #name-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #start-button {
            padding: 15px 40px;
            font-size: 1.5em;
            font-weight: bold;
            color: black;
            background-color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
        }

        /* Thêm style cho nút điều khiển nhạc */
        #music-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #music-toggle.visible {
            opacity: 1;
        }

        /* CSS MỚI CHO ĐIỂM SỐ */
        #score-display {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.8em;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            z-index: 5;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out, transform 0.5s ease-in-out;
            text-align: center;
        }

        #score-display.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        #score-display.fade-out {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
    </style>
</head>
<body>
        <div id="start-screen">
        <h1>Gửi Lời Chúc 2k7</h1>
        <p>Nhập tên của em ở đấy nhé!</p>
        <input type="text" id="name-input" placeholder="Họ và tên">
        <button id="start-button">Bấm vô đây nè!</button>
    </div>

    <div id="score-display">
        Chúc mừng em đã đạt được số điểm: <span id="chosen-score"></span>!
    </div>

        <canvas id="loveWallCanvas"></canvas>
    <audio id="background-music" loop>
        <source src="phepmau.mp3" type="audio/mpeg">
        Trình duyệt của bạn không hỗ trợ phát âm thanh.
    </audio>

    <button id="music-toggle" style="display: none;">Tắt nhạc</button>

    <script>
        // --- Lấy các phần tử HTML ---
        const canvas = document.getElementById('loveWallCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const nameInput = document.getElementById('name-input');
        const startButton = document.getElementById('start-button');
        const music = document.getElementById('background-music');
        const musicToggleButton = document.getElementById('music-toggle');
        const scoreDisplay = document.getElementById('score-display'); // Lấy element mới
        const chosenScoreSpan = document.getElementById('chosen-score'); // Lấy element mới


        // --- Cài đặt Canvas ---
        // Đặt kích thước canvas ban đầu
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- CÁC HẰNG SỐ CẤU HÌNH ---
        // Đặt tên các hằng số rõ ràng hơn, thêm MIN/MAX cho các giá trị ngẫu nhiên
        const PARTICLE_SPAWN_INTERVAL_SECONDS = 0.2; // Thời gian giữa các lần sinh hạt
        const PARTICLE_MIN_VELOCITY_Y = 50; // Vận tốc Y tối thiểu (pixels/giây)
        const PARTICLE_MAX_VELOCITY_Y_OFFSET = 50; // Khoảng dao động của vận tốc Y
        const PARTICLE_MAX_VELOCITY_X_OFFSET = 50; // Khoảng dao động của vận tốc X
        const TEXT_MIN_FONT_SIZE = 20; // Kích thước font tối thiểu
        const TEXT_MAX_FONT_SIZE_OFFSET = 10; // Khoảng dao động của kích thước font
        const HEART_MIN_SIZE = 25; // Kích thước trái tim tối thiểu
        const HEART_MAX_SIZE_OFFSET = 15; // Khoảng dao động của kích thước trái tim
        const PARTICLE_MIN_LIFESPAN_SECONDS = 10.0; // Tuổi thọ tối thiểu của hạt (giây)
        const PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS = 10.0; // Khoảng dao động của tuổi thọ
        const HEART_SPAWN_CHANCE = 0.1; // Tỷ lệ xuất hiện trái tim (10%)
        const SCORE_SPAWN_CHANCE = 0.05; // Tỷ lệ xuất hiện điểm số (5%)
        const SCORE_MIN = 6; // Điểm số tối thiểu có thể rơi
        const SCORE_MAX = 10; // Điểm số tối đa có thể rơi
        const SCORE_DISPLAY_DURATION_SECONDS = 3; // Thời gian hiển thị điểm số sau khi click


        // --- TEXT GENERATOR ---
        class TextGenerator {
            constructor() {
                this.baseMessages = [
                    "Bình tĩnh, tự tin, chiến thắng!", "Chúc các em thi tốt",
                    "Mục tiêu 10 điểm!", "Đỗ nguyện vọng 1 nhé!","100 trịu nhaaa",
                    "Làm bài cẩn thận, không sai ngu", "Cố lên các sĩ tử!",
                    "Vượt mọi giới hạn lim", "Hàm số đồng biến, điểm số tăng đều",
                    "Tìm max(điểm)", "Oxyz muôn năm", "Tích phân không đổi cận",
                    "∫f(x)dx", "x → +∞", "Δ = b² - 4ac", "a² + b² = c²",
                    "sin²α + cos²α = 1", "logₐb", "z = a + bi", "π", "e", "∞", "∀x ∈ R", "f'(x₀)"
                ];
                this.messages = [...this.baseMessages];
            }

            personalize(name) {
                if (name && name.trim() !== '') {
                    const trimmedName = name.trim();
                    if (!this.messages.includes(`Chúc ${trimmedName} thi tốt!`)) {
                        this.messages.push(`Chúc ${trimmedName} thi tốt!`);
                        this.messages.push(`${trimmedName} cố lên!`);
                        this.messages.push(`${trimmedName} đỗ NV1!`);
                        this.messages.push(`${trimmedName} lấy đc 100 trịu nhé!`);
                    }
                }
            }

            getRandomText() {
                if (this.messages.length === 0) return "Chúc may mắn!";
                return this.messages[Math.floor(Math.random() * this.messages.length)];
            }
        }

        // --- PARTICLE (LỚP CHA) ---
        class Particle {
            constructor(x, y, velocityX, velocityY, lifeSpan) {
                this.x = x;
                this.y = y;
                this.velocityX = velocityX;
                this.velocityY = velocityY;
                this.lifeSpan = lifeSpan;
                this.age = 0;
                this.opacity = 1.0;
                this.alive = true;
                this.type = 'generic';
            }

            update(deltaTime) {
                if (!this.alive) return;

                this.x += this.velocityX * deltaTime;
                this.y += this.velocityY * deltaTime;
                this.age += deltaTime;

                if (this.age >= this.lifeSpan) {
                    this.alive = false;
                } else {
                    this.opacity = 1.0 - (this.age / this.lifeSpan);
                }
            }

            render(ctx) {}
        }

        // --- TEXT PARTICLE (VÀ HEART PARTICLE) ---
        class TextParticle extends Particle {
            constructor(text, x, y, velocityX, velocityY, font, color, lifeSpan) {
                super(x, y, velocityX, velocityY, lifeSpan);
                this.text = text;
                this.font = font;
                this.color = color;
                this.type = 'text';
            }

            render(ctx) {
                if (!this.alive) return;

                ctx.font = this.font;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity})`;
                ctx.fillText(this.text, this.x, this.y);
            }
        }

        // --- SCORE PARTICLE (Lớp điểm số mới) ---
        class ScoreParticle extends Particle {
            constructor(score, x, y, velocityX, velocityY, font, color, lifeSpan) {
                super(x, y, velocityX, velocityY, lifeSpan);
                this.score = score;
                this.font = font;
                this.color = color;
                this.type = 'score';

                // Tạm thời thiết lập font để đo kích thước
                ctx.font = this.font;
                this.width = ctx.measureText(this.score.toString()).width;
                this.height = parseFloat(this.font); // Ước lượng chiều cao từ kích thước font
            }

            render(ctx) {
                if (!this.alive) return;

                ctx.font = this.font;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity})`;
                ctx.fillText(this.score.toString(), this.x, this.y);

                // For debugging: Draw bounding box
                // ctx.strokeStyle = 'red';
                // ctx.strokeRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
            }

            // Kiểm tra xem một điểm (px, py) có nằm trong hạt này không
            isClicked(px, py) {
                const left = this.x - this.width / 2;
                const right = this.x + this.width / 2;
                const top = this.y - this.height / 2;
                const bottom = this.y + this.height / 2;

                return px >= left && px <= right && py >= top && py <= bottom;
            }
        }

        // --- PARTICLE FACTORY ---
        class ParticleFactory {
            constructor(textGenerator) {
                this.textGenerator = textGenerator;
            }

            createRandomTextParticle(canvasWidth) {
                const text = this.textGenerator.getRandomText();
                const x = Math.random() * canvasWidth;
                const y = -20;
                const velocityX = (Math.random() - 0.5) * PARTICLE_MAX_VELOCITY_X_OFFSET;
                const velocityY = PARTICLE_MIN_VELOCITY_Y + Math.random() * PARTICLE_MAX_VELOCITY_Y_OFFSET;
                const fontSize = TEXT_MIN_FONT_SIZE + Math.random() * TEXT_MAX_FONT_SIZE_OFFSET;
                const font = `bold ${fontSize}px 'Segoe UI'`;
                const color = {
                    r: Math.floor(Math.random() * 256),
                    g: Math.floor(Math.random() * 256),
                    b: Math.floor(Math.random() * 256)
                };
                const lifeSpan = PARTICLE_MIN_LIFESPAN_SECONDS + Math.random() * PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS;
                return new TextParticle(text, x, y, velocityX, velocityY, font, color, lifeSpan);
            }

            createRandomHeartParticle(canvasWidth) {
                const x = Math.random() * canvasWidth;
                const y = -20;
                const velocityX = (Math.random() - 0.5) * PARTICLE_MAX_VELOCITY_X_OFFSET * 0.6;
                const velocityY = (PARTICLE_MIN_VELOCITY_Y * 0.6) + Math.random() * (PARTICLE_MAX_VELOCITY_Y_OFFSET * 0.6);
                const fontSize = HEART_MIN_SIZE + Math.random() * HEART_MAX_SIZE_OFFSET;
                const font = `bold ${fontSize}px 'Segoe UI'`;
                const color = { r: 255, g: Math.floor(Math.random() * 100), b: Math.floor(Math.random() * 100) };
                const lifeSpan = PARTICLE_MIN_LIFESPAN_SECONDS + Math.random() * PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS;
                return new TextParticle("❤", x, y, velocityX, velocityY, font, color, lifeSpan);
            }

            createRandomScoreParticle(canvasWidth) {
                const score = Math.floor(Math.random() * (SCORE_MAX - SCORE_MIN + 1)) + SCORE_MIN;
                const x = Math.random() * canvasWidth;
                const y = -20;
                const velocityX = (Math.random() - 0.5) * PARTICLE_MAX_VELOCITY_X_OFFSET * 0.8;
                const velocityY = (PARTICLE_MIN_VELOCITY_Y * 0.8) + Math.random() * (PARTICLE_MAX_VELOCITY_Y_OFFSET * 0.8);
                const fontSize = 40 + Math.random() * 20;
                const font = `bold ${fontSize}px 'Segoe UI'`;
                const color = { r: Math.floor(Math.random() * 100) + 155, g: Math.floor(Math.random() * 100) + 155, b: 0 };
                const lifeSpan = PARTICLE_MIN_LIFESPAN_SECONDS * 0.8 + Math.random() * PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS * 0.8;
                return new ScoreParticle(score, x, y, velocityX, velocityY, font, color, lifeSpan);
            }
        }

        // --- PARTICLE SYSTEM ---
        class ParticleSystem {
            constructor() {
                this.particles = [];
            }

            addParticle(particle) {
                this.particles.push(particle);
            }

            update(deltaTime) {
                this.particles = this.particles.filter(p => {
                    p.update(deltaTime);
                    return p.alive && p.y < canvas.height + 100 && p.y > -100;
                });
            }

            render(ctx) {
                for (const particle of this.particles) {
                    particle.render(ctx);
                }
            }

            handleClick(clickX, clickY) {
                let scoreFound = false;
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    // Chỉ kiểm tra các hạt điểm số
                    if (p.type === 'score' && p.isClicked(clickX, clickY)) {
                        chosenScoreSpan.textContent = p.score;
                        scoreDisplay.classList.remove('fade-out');
                        scoreDisplay.classList.add('visible');
                        
                        // Đặt hẹn giờ để ẩn điểm sau vài giây
                        clearTimeout(scoreDisplay.timeoutId);
                        scoreDisplay.timeoutId = setTimeout(() => {
                            scoreDisplay.classList.remove('visible');
                            scoreDisplay.classList.add('fade-out');
                        }, SCORE_DISPLAY_DURATION_SECONDS * 1000);

                        // Cho hạt điểm số biến mất nhanh chóng sau khi được click
                        p.lifeSpan = p.age + 0.5;
                        scoreFound = true;
                        break; // Chỉ xử lý một điểm mỗi lần click
                    }
                }
                return scoreFound;
            }
        }

        // --- KHỞI TẠO CÁC HỆ THỐNG VÀ BIẾN GLOBAL ---
        const textGenerator = new TextGenerator();
        const particleFactory = new ParticleFactory(textGenerator);
        const particleSystem = new ParticleSystem();
        let lastUpdateTime = 0;
        let timeSinceLastSpawn = 0;
        let animationFrameId = null;
        let isMusicPlaying = false;

        // --- VÒNG LẶP ANIMATION CHÍNH ---
        function animationLoop(currentTime) {
            if (!lastUpdateTime) {
                lastUpdateTime = currentTime;
            }
            const deltaTime = (currentTime - lastUpdateTime) / 1000;
            lastUpdateTime = currentTime;

            timeSinceLastSpawn += deltaTime;
            if (timeSinceLastSpawn >= PARTICLE_SPAWN_INTERVAL_SECONDS) {
                const randomChance = Math.random();
                if (randomChance < SCORE_SPAWN_CHANCE) {
                    particleSystem.addParticle(particleFactory.createRandomScoreParticle(canvas.width));
                } else if (randomChance < SCORE_SPAWN_CHANCE + HEART_SPAWN_CHANCE) {
                    particleSystem.addParticle(particleFactory.createRandomHeartParticle(canvas.width));
                } else {
                    particleSystem.addParticle(particleFactory.createRandomTextParticle(canvas.width));
                }
                timeSinceLastSpawn = 0;
            }

            particleSystem.update(deltaTime);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particleSystem.render(ctx);
            animationFrameId = requestAnimationFrame(animationLoop);
        }

        // --- HÀM XỬ LÝ NHẠC ---
        function toggleMusic() {
            if (music.paused) {
                music.play().then(() => {
                    isMusicPlaying = true;
                    musicToggleButton.textContent = 'Tắt nhạc';
                }).catch(e => {
                    console.error("Không thể phát nhạc:", e);
                    alert("Trình duyệt chặn tự động phát nhạc. Vui lòng bấm để bật nhạc thủ công.");
                    isMusicPlaying = false;
                    musicToggleButton.textContent = 'Bật nhạc';
                });
            } else {
                music.pause();
                isMusicPlaying = false;
                musicToggleButton.textContent = 'Bật nhạc';
            }
        }

        // --- XỬ LÝ SỰ KIỆN KHI NHẤN NÚT BẮT ĐẦU ---
        startButton.addEventListener('click', () => {
            const userName = nameInput.value;
            textGenerator.personalize(userName);

            startScreen.classList.add('hidden');

            musicToggleButton.style.display = 'block';
            setTimeout(() => musicToggleButton.classList.add('visible'), 50);

            toggleMusic();

            if (!animationFrameId) {
                animationFrameId = requestAnimationFrame(animationLoop);
            }
        });

        // --- XỬ LÝ KHI THAY ĐỔI KÍCH THƯỚC CỬA SỔ ---
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // --- XỬ LÝ SỰ KIỆN NÚT ĐIỀU KHIỂN NHẠC ---
        musicToggleButton.addEventListener('click', toggleMusic);

        // --- XỬ LÝ SỰ KIỆN CLICK TRÊN CANVAS (Bắt điểm số) ---
        // Giữ nguyên cursor pointer cho canvas để chỉ ra có thể click
        canvas.style.cursor = 'pointer'; 
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            particleSystem.handleClick(clickX, clickY);
        });

        // Đảm bảo nhạc bắt đầu ở trạng thái tạm dừng
        music.pause();
        music.currentTime = 0;
    </script>
</body>
</html>
