<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chúc các em thi tốt nha!!!</title>
    <style>
        /* CSS cho toàn bộ trang và giao diện bắt đầu */
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; /* Dùng flexbox để căn giữa dễ hơn */
            justify-content: center;
            align-items: center;
            height: 100vh; /* Đảm bảo body chiếm toàn bộ chiều cao viewport */
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Canvas nằm dưới giao diện */
            cursor: pointer; /* Thay đổi con trỏ để chỉ ra có thể click */
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7); /* Nền đen mờ */
            z-index: 2; /* Giao diện nằm trên canvas */
            color: white;
            text-align: center;
            transition: opacity 1s ease-out, visibility 1s ease-out; /* Thêm transition cho visibility */
        }
        #start-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Không cho phép tương tác khi đã ẩn */
            visibility: hidden; /* Ẩn hoàn toàn khỏi DOM sau khi mờ dần */
        }
        #start-screen h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
        }
        #start-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 80%;
        }
        #name-input {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            border: 2px solid white;
            background-color: transparent;
            color: white;
            text-align: center;
            width: 300px;
            margin-bottom: 30px;
            outline: none;
        }
        #name-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        #start-button {
            padding: 15px 40px;
            font-size: 1.5em;
            font-weight: bold;
            color: black;
            background-color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
        }

        /* Thêm style cho nút điều khiển nhạc */
        #music-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10; /* Đảm bảo nút nằm trên mọi thứ */
            opacity: 0; /* Ẩn ban đầu */
            transition: opacity 0.5s ease-in-out;
        }
        #music-toggle.visible {
            opacity: 1;
        }

        #score-display {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.8em;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            z-index: 5; /* Nằm trên canvas nhưng dưới start-screen */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out, transform 0.5s ease-in-out;
            text-align: center;
        }

        #score-display.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        #score-display.fade-out {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1>Gửi Lời Chúc 2k7</h1>
        <p>Nhập tên của em ở đấy nhé!</p>
        <input type="text" id="name-input" placeholder="Họ và tên">
        <button id="start-button">Bấm vô đây nè!</button>
    </div>

    <div id="score-display">
        Chúc mừng em đã đạt được số điểm: <span id="chosen-score"></span>!
    </div>

    <canvas id="loveWallCanvas"></canvas>
    <audio id="background-music" loop>
        <source src="phepmau.mp3" type="audio/mpeg">
        Trình duyệt của bạn không hỗ trợ phát âm thanh.
    </audio>

    <button id="music-toggle" style="display: none;">Tắt nhạc</button>

    <script>
        // --- Lấy các phần tử HTML ---
        const canvas = document.getElementById('loveWallCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const nameInput = document.getElementById('name-input');
        const startButton = document.getElementById('start-button');
        const music = document.getElementById('background-music');
        const musicToggleButton = document.getElementById('music-toggle');
        const scoreDisplay = document.getElementById('score-display');
        const chosenScoreSpan = document.getElementById('chosen-score');


        // --- Cài đặt Canvas ---
        // Đặt kích thước canvas ban đầu
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- CÁC HẰNG SỐ CẤU HÌNH ---
        // Đặt tên các hằng số rõ ràng hơn, thêm MIN/MAX cho các giá trị ngẫu nhiên
        const PARTICLE_SPAWN_INTERVAL_SECONDS = 0.2; // Thời gian giữa các lần sinh hạt
        const PARTICLE_MIN_VELOCITY_Y = 50; // Vận tốc Y tối thiểu (pixels/giây)
        const PARTICLE_MAX_VELOCITY_Y_OFFSET = 50; // Khoảng dao động của vận tốc Y
        const PARTICLE_MAX_VELOCITY_X_OFFSET = 50; // Khoảng dao động của vận tốc X
        const TEXT_MIN_FONT_SIZE = 20; // Kích thước font tối thiểu
        const TEXT_MAX_FONT_SIZE_OFFSET = 10; // Khoảng dao động của kích thước font
        const HEART_MIN_SIZE = 25; // Kích thước trái tim tối thiểu
        const HEART_MAX_SIZE_OFFSET = 15; // Khoảng dao động của kích thước trái tim
        const PARTICLE_MIN_LIFESPAN_SECONDS = 10.0; // Tuổi thọ tối thiểu của hạt (giây)
        const PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS = 10.0; // Khoảng dao động của tuổi thọ
        const HEART_SPAWN_CHANCE = 0.1; // Tỷ lệ xuất hiện trái tim (10%)
        const SCORE_SPAWN_CHANCE = 0.05; // Tỷ lệ xuất hiện điểm số (5%)
        const SCORE_MIN = 6; // Điểm số tối thiểu có thể rơi
        const SCORE_MAX = 10; // Điểm số tối đa có thể rơi
        const SCORE_DISPLAY_DURATION_SECONDS = 3; // Thời gian hiển thị điểm số sau khi click


        // --- TEXT GENERATOR ---
        class TextGenerator {
            constructor() {
                this.baseMessages = [
                    "Bình tĩnh, tự tin, chiến thắng!", "Chúc các em thi tốt",
                    "Mục tiêu 10 điểm!", "Đỗ nguyện vọng 1 nhé!","100 trịu nhaaa",
                    "Làm bài cẩn thận, không sai ngu", "Cố lên các sĩ tử!",
                    "Vượt mọi giới hạn lim", "Hàm số đồng biến, điểm số tăng đều",
                    "Tìm max(điểm)", "Oxyz muôn năm", "Tích phân không đổi cận",
                    "∫f(x)dx", "x → +∞", "Δ = b² - 4ac", "a² + b² = c²",
                    "sin²α + cos²α = 1", "logₐb", "z = a + bi", "π", "e", "∞", "∀x ∈ R", "f'(x₀)"
                ];
                // Sao chép baseMessages sang messages để có thể thêm tin nhắn cá nhân mà không làm mất gốc
                this.messages = [...this.baseMessages];
            }

            personalize(name) {
                if (name && name.trim() !== '') {
                    const trimmedName = name.trim();
                    // Thêm các tin nhắn cá nhân hóa một cách an toàn, tránh trùng lặp nếu người dùng nhập lại
                    if (!this.messages.includes(`Chúc ${trimmedName} thi tốt!`)) {
                        this.messages.push(`Chúc ${trimmedName} thi tốt!`);
                        this.messages.push(`${trimmedName} cố lên!`);
                        this.messages.push(`${trimmedName} đỗ NV1!`);
                        this.messages.push(`${trimmedName} lấy đc 100 trịu nhé!`);
                    }
                }
            }

            getRandomText() {
                if (this.messages.length === 0) return "Chúc may mắn!"; // Trường hợp không có tin nhắn nào
                return this.messages[Math.floor(Math.random() * this.messages.length)];
            }
        }

        // --- PARTICLE (LỚP CHA) ---
        class Particle {
            constructor(x, y, velocityX, velocityY, lifeSpan) {
                this.x = x;
                this.y = y;
                this.velocityX = velocityX;
                this.velocityY = velocityY;
                this.lifeSpan = lifeSpan; // Tổng thời gian sống
                this.age = 0; // Thời gian đã sống
                this.opacity = 1.0;
                this.alive = true; // Cờ hiệu để biết hạt còn sống hay không
                this.type = 'generic'; // Thêm loại hạt
            }

            update(deltaTime) {
                if (!this.alive) return;

                this.x += this.velocityX * deltaTime;
                this.y += this.velocityY * deltaTime;
                this.age += deltaTime;

                if (this.age >= this.lifeSpan) {
                    this.alive = false; // Đánh dấu hạt đã chết
                } else {
                    // Tính độ mờ, mờ dần khi gần hết tuổi thọ
                    this.opacity = 1.0 - (this.age / this.lifeSpan);
                }
            }

            // Phương thức render rỗng, sẽ được ghi đè bởi lớp con
            render(ctx) {}
        }

        // --- TEXT PARTICLE (VÀ HEART PARTICLE) ---
        class TextParticle extends Particle {
            constructor(text, x, y, velocityX, velocityY, font, color, lifeSpan) {
                super(x, y, velocityX, velocityY, lifeSpan); // Gọi constructor của lớp cha
                this.text = text;
                this.font = font;
                this.color = color; // { r, g, b }
                this.type = 'text'; // Đặt loại hạt là 'text'
            }

            render(ctx) {
                if (!this.alive) return;

                ctx.font = this.font;
                ctx.textAlign = 'center'; // Căn giữa văn bản cho dễ xử lý click
                ctx.textBaseline = 'middle'; // Căn giữa dọc văn bản
                // Đặt màu với độ mờ hiện tại
                ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity})`;
                ctx.fillText(this.text, this.x, this.y);
            }
        }

        // --- SCORE PARTICLE (Lớp điểm số mới) ---
        class ScoreParticle extends Particle {
            constructor(score, x, y, velocityX, velocityY, font, color, lifeSpan) {
                super(x, y, velocityX, velocityY, lifeSpan);
                this.score = score;
                this.font = font;
                this.color = color;
                this.type = 'score'; // Đặt loại hạt là 'score'
                // Tính toán kích thước gần đúng để kiểm tra click
                // Lưu ý: measureText cần được gọi sau khi font được thiết lập
                // Để đảm bảo measureText hoạt động chính xác, cần thiết lập font trước khi gọi nó
                ctx.font = this.font;
                this.width = ctx.measureText(this.score.toString()).width;
                this.height = parseFloat(this.font); // Lấy giá trị số từ font (e.g., "50px")
            }

            render(ctx) {
                if (!this.alive) return;

                ctx.font = this.font;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity})`;
                ctx.fillText(this.score.toString(), this.x, this.y);

                // For debugging: Draw bounding box
                // ctx.strokeStyle = 'red';
                // ctx.strokeRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
            }

            // Kiểm tra xem một điểm (px, py) có nằm trong hạt này không
            isClicked(px, py) {
                // Điều chỉnh theo textAlign và textBaseline
                const left = this.x - this.width / 2;
                const right = this.x + this.width / 2;
                const top = this.y - this.height / 2;
                const bottom = this.y + this.height / 2;

                return px >= left && px <= right && py >= top && py <= bottom;
            }
        }

        // --- PARTICLE FACTORY ---
        class ParticleFactory {
            constructor(textGenerator) {
                this.textGenerator = textGenerator;
            }

            createRandomTextParticle(canvasWidth) {
                const text = this.textGenerator.getRandomText();
                const x = Math.random() * canvasWidth; // Vị trí X ngẫu nhiên
                const y = -20; // Bắt đầu từ trên cùng màn hình
                const velocityX = (Math.random() - 0.5) * PARTICLE_MAX_VELOCITY_X_OFFSET; // Vận tốc X ngẫu nhiên
                const velocityY = PARTICLE_MIN_VELOCITY_Y + Math.random() * PARTICLE_MAX_VELOCITY_Y_OFFSET; // Vận tốc Y ngẫu nhiên
                const fontSize = TEXT_MIN_FONT_SIZE + Math.random() * TEXT_MAX_FONT_SIZE_OFFSET;
                const font = `bold ${fontSize}px 'Segoe UI'`;
                // Màu ngẫu nhiên
                const color = {
                    r: Math.floor(Math.random() * 256),
                    g: Math.floor(Math.random() * 256),
                    b: Math.floor(Math.random() * 256)
                };
                const lifeSpan = PARTICLE_MIN_LIFESPAN_SECONDS + Math.random() * PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS;
                return new TextParticle(text, x, y, velocityX, velocityY, font, color, lifeSpan);
            }

            createRandomHeartParticle(canvasWidth) {
                const x = Math.random() * canvasWidth;
                const y = -20;
                // Vận tốc trái tim thường chậm hơn một chút
                const velocityX = (Math.random() - 0.5) * PARTICLE_MAX_VELOCITY_X_OFFSET * 0.6;
                const velocityY = (PARTICLE_MIN_VELOCITY_Y * 0.6) + Math.random() * (PARTICLE_MAX_VELOCITY_Y_OFFSET * 0.6);
                const fontSize = HEART_MIN_SIZE + Math.random() * HEART_MAX_SIZE_OFFSET;
                const font = `bold ${fontSize}px 'Segoe UI'`;
                // Màu trái tim thường là đỏ
                const color = { r: 255, g: Math.floor(Math.random() * 100), b: Math.floor(Math.random() * 100) };
                const lifeSpan = PARTICLE_MIN_LIFESPAN_SECONDS + Math.random() * PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS;
                return new TextParticle("❤", x, y, velocityX, velocityY, font, color, lifeSpan);
            }

            // Phương thức mới để tạo hạt điểm số
            createRandomScoreParticle(canvasWidth) {
                const score = Math.floor(Math.random() * (SCORE_MAX - SCORE_MIN + 1)) + SCORE_MIN;
                const x = Math.random() * canvasWidth;
                const y = -20;
                const velocityX = (Math.random() - 0.5) * PARTICLE_MAX_VELOCITY_X_OFFSET * 0.8; // Hơi chậm hơn
                const velocityY = (PARTICLE_MIN_VELOCITY_Y * 0.8) + Math.random() * (PARTICLE_MAX_VELOCITY_Y_OFFSET * 0.8);
                const fontSize = 40 + Math.random() * 20; // Điểm số to hơn một chút
                const font = `bold ${fontSize}px 'Segoe UI'`;
                const color = { r: Math.floor(Math.random() * 100) + 155, g: Math.floor(Math.random() * 100) + 155, b: 0 }; // Màu vàng-cam
                const lifeSpan = PARTICLE_MIN_LIFESPAN_SECONDS * 0.8 + Math.random() * PARTICLE_MAX_LIFESPAN_OFFSET_SECONDS * 0.8;
                return new ScoreParticle(score, x, y, velocityX, velocityY, font, color, lifeSpan);
            }
        }

        // --- PARTICLE SYSTEM ---
        class ParticleSystem {
            constructor() {
                this.particles = [];
            }

            addParticle(particle) {
                this.particles.push(particle);
            }

            update(deltaTime) {
                // Duyệt ngược và xóa các hạt đã chết hoặc ra khỏi màn hình
                this.particles = this.particles.filter(p => {
                    p.update(deltaTime);
                    // Giữ lại hạt còn sống và nằm trong hoặc gần màn hình
                    return p.alive && p.y < canvas.height + 100 && p.y > -100; // Thêm buffer để không biến mất quá sớm
                });
            }

            render(ctx) {
                // Chỉ vẽ các hạt còn sống
                for (const particle of this.particles) {
                    particle.render(ctx);
                }
            }

            // Phương thức mới để xử lý click
            handleClick(clickX, clickY) {
                let scoreFound = false;
                // Duyệt ngược để xử lý các hạt ở trên cùng (vẽ sau cùng) trước
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    if (p.type === 'score' && p.isClicked(clickX, clickY)) {
                        chosenScoreSpan.textContent = p.score;
                        scoreDisplay.classList.remove('fade-out'); // Đảm bảo không có fade-out
                        scoreDisplay.classList.add('visible'); // Hiển thị điểm đã chọn
                        
                        // Đặt hẹn giờ để ẩn điểm sau vài giây
                        clearTimeout(scoreDisplay.timeoutId); // Xóa timeout cũ nếu có
                        scoreDisplay.timeoutId = setTimeout(() => {
                            scoreDisplay.classList.remove('visible');
                            scoreDisplay.classList.add('fade-out'); // Thêm fade-out effect
                        }, SCORE_DISPLAY_DURATION_SECONDS * 1000);

                        // Đánh dấu hạt điểm số đã được "lấy" để nó biến mất nhanh hơn
                        p.lifeSpan = p.age + 0.5; // Cho hạt này sống thêm 0.5 giây rồi biến mất
                        scoreFound = true;
                        break; // Chỉ xử lý một điểm mỗi lần click
                    }
                }
                return scoreFound; 
            }
        }

        // --- KHỞI TẠO CÁC HỆ THỐNG VÀ BIẾN GLOBAL ---
        const textGenerator = new TextGenerator();
        const particleFactory = new ParticleFactory(textGenerator);
        const particleSystem = new ParticleSystem();
        let lastUpdateTime = 0; // Thời gian của khung hình trước
        let timeSinceLastSpawn = 0; // Thời gian kể từ lần cuối sinh hạt
        let animationFrameId = null; // ID của requestAnimationFrame
        let isMusicPlaying = false; // Trạng thái nhạc

        // --- VÒNG LẶP ANIMATION CHÍNH ---
        function animationLoop(currentTime) {
            // Lần đầu tiên chạy, gán lastUpdateTime
            if (!lastUpdateTime) {
                lastUpdateTime = currentTime;
            }
            // Tính toán deltaTime (thời gian giữa 2 khung hình)
            const deltaTime = (currentTime - lastUpdateTime) / 1000; // Đổi từ miliseconds sang giây
            lastUpdateTime = currentTime;

            // Cập nhật thời gian sinh hạt
            timeSinceLastSpawn += deltaTime;
            if (timeSinceLastSpawn >= PARTICLE_SPAWN_INTERVAL_SECONDS) {
                // Random để sinh chữ, trái tim hoặc điểm số
                const randomChance = Math.random();
                if (randomChance < SCORE_SPAWN_CHANCE) {
                    particleSystem.addParticle(particleFactory.createRandomScoreParticle(canvas.width));
                } else if (randomChance < SCORE_SPAWN_CHANCE + HEART_SPAWN_CHANCE) {
                    particleSystem.addParticle(particleFactory.createRandomHeartParticle(canvas.width));
                } else {
                    particleSystem.addParticle(particleFactory.createRandomTextParticle(canvas.width));
                }
                timeSinceLastSpawn = 0; // Reset bộ đếm thời gian sinh hạt
            }

            // Cập nhật trạng thái và vị trí của tất cả các hạt
            particleSystem.update(deltaTime);

            // Xóa toàn bộ canvas để vẽ lại
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Vẽ lại tất cả các hạt
            particleSystem.render(ctx);

            // Yêu cầu khung hình tiếp theo
            animationFrameId = requestAnimationFrame(animationLoop);
        }

        // --- HÀM XỬ LÝ NHẠC ---
        function toggleMusic() {
            if (music.paused) {
                music.play().then(() => {
                    isMusicPlaying = true;
                    musicToggleButton.textContent = 'Tắt nhạc';
                }).catch(e => {
                    console.error("Không thể phát nhạc:", e);
                    // Có thể thông báo cho người dùng nếu cần
                    alert("Trình duyệt chặn tự động phát nhạc. Vui lòng bấm để bật nhạc thủ công.");
                    isMusicPlaying = false;
                    musicToggleButton.textContent = 'Bật nhạc';
                });
            } else {
                music.pause();
                isMusicPlaying = false;
                musicToggleButton.textContent = 'Bật nhạc';
            }
        }


        // --- XỬ LÝ SỰ KIỆN KHI NHẤN NÚT BẮT ĐẦU ---
        startButton.addEventListener('click', () => {
            const userName = nameInput.value;
            textGenerator.personalize(userName);

            // Ẩn màn hình bắt đầu một cách mượt mà
            startScreen.classList.add('hidden');

            // Hiển thị nút điều khiển nhạc và bắt đầu phát
            musicToggleButton.style.display = 'block';
            setTimeout(() => musicToggleButton.classList.add('visible'), 50); // Cho phép CSS transition hoạt động

            toggleMusic(); // Cố gắng phát nhạc khi bắt đầu

            // Bắt đầu vòng lặp animation
            // Chỉ gọi requestAnimationFrame một lần duy nhất
            if (!animationFrameId) {
                animationFrameId = requestAnimationFrame(animationLoop);
            }
        });

        // --- XỬ LÝ KHI THAY ĐỔI KÍCH THƯỚC CỬA SỔ ---
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // --- XỬ LÝ SỰ KIỆN NÚT ĐIỀU KHIỂN NHẠC ---
        musicToggleButton.addEventListener('click', toggleMusic);

        // --- XỬ LÝ SỰ KIỆN CLICK TRÊN CANVAS (Bắt điểm số) ---
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            // Gọi phương thức xử lý click của ParticleSystem
            particleSystem.handleClick(clickX, clickY);
        });

        // Đảm bảo nhạc bắt đầu ở trạng thái tạm dừng
        music.pause();
        music.currentTime = 0;
    </script>
</body>
</html>
